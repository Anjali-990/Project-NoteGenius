{% extends "index.html" %}
{% load static %}
{% block main %}

<section class="upload-section container">
  <div class="upload-card mx-auto">
    <h3 class="text-center">Upload Audio to Generate Notes</h3>
    <p class="text-center text-muted">
      Upload your audio file or record your voice. Our AI assistant will convert
      speech into clean notes.
    </p>

    <form id="audioUploadForm" enctype="multipart/form-data">
      {% csrf_token %}
      <!-- Drop Area -->
      <div class="drop-area text-center">
        <i class="fas fa-microphone-lines"></i>
        <h6>Drag & Drop your audio file here</h6>
        <p class="text-muted mb-1">or click below to select</p>

        <input
          type="file"
          class="form-control mt-2"
          accept="audio/*,.mp3,.wav,.m4a"
          id="audioInput"
          name="file"
        />
      </div>
      <br>

      <!-- Recording Section -->
      <div class="my-3">
        <label class="form-label fw-semibold text-secondary">
          Or record your voice:
        </label>

        <div class="d-flex flex-wrap gap-2">
          <button
            type="button"
            id="startRecord"
            class="btn btn-outline-primary btn-sm"
          >
            <i class="fas fa-circle-dot me-2"></i> Start Recording
          </button>

          <button
            type="button"
            id="stopRecord"
            class="btn btn-outline-danger btn-sm"
            disabled
          >
            <i class="fas fa-square me-2" style="color: #dc3545 !important; opacity: 1 !important;"></i> 
            <span style="color: #dc3545 !important; font-weight: bold; opacity: 1 !important;">Stop</span>
          </button>
        </div>

        <audio id="audioPreview" controls class="mt-3 w-100 d-none"></audio>
      </div>

      <div class="my-3">
        <!-- optional: let user choose short/medium/long if you want -->
        <select id="summaryLengthSelect" class="form-control" name="summary_length" style="max-width:260px;">
          <option value="medium" selected>Medium (Balanced)</option>
          <option value="short">Short (Quick)</option>
          <option value="long">Long (Detailed)</option>
        </select>
      </div>

      <button type="submit" id="generateAudioBtn" class="generate-btn w-100">
        <i class="fas fa-wand-magic-sparkles me-2"></i> Generate Notes
      </button>
    </form>
    <br>

    <!-- Result Section -->
    <div class="result-section d-none" id="audioResultSection">
      <h5 class="mt-4">
        <i class="fas fa-wand-magic-sparkles me-2"></i> Generated Notes:
      </h5>

      <div id="transcriptBox" class="mb-3"></div>

      <div id="summaryBox" class="mt-2">
        <!-- short summary -->
        <h6>⭐ Short Summary</h6>
        <p id="shortSummary"></p>

        <h6>⭐ Bullet Points</h6>
        <ul id="bulletsList"></ul>

        <h6>⭐ Detailed Explanation</h6>
        <p id="detailedExplanation"></p>

        <h6>⭐ Key Terms</h6>
        <ul id="keyTermsList"></ul>
      </div>

      <div class="d-flex gap-2 mt-3">
        <a id="downloadPdfBtn" href="{% url 'download_pdf' %}" class="btn btn-primary w-50" target="_blank">
          <i class="fas fa-file-pdf me-1"></i> Export as PDF
        </a>
        <a id="downloadDocxBtn" href="{% url 'download_docx' %}" class="btn btn-outline-primary w-50" target="_blank">
          <i class="fas fa-file-word me-1"></i> Export as Word
        </a>
      </div>

    </div>
  </div>
</section>

<script>
  // CSRF helper (Django)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Recording logic
  let mediaRecorder;
  let audioChunks = [];
  const startBtn = document.getElementById("startRecord");
  const stopBtn = document.getElementById("stopRecord");
  const audioPreview = document.getElementById("audioPreview");
  const audioInput = document.getElementById("audioInput");

  startBtn.addEventListener("click", async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.start();

      startBtn.disabled = true;
      stopBtn.disabled = false;

      mediaRecorder.ondataavailable = (e) => {
        audioChunks.push(e.data);
      };
    } catch (err) {
      alert("Microphone access denied or not available.");
    }
  });

  stopBtn.addEventListener("click", () => {
    if (!mediaRecorder) return;
    mediaRecorder.stop();
    stopBtn.disabled = true;
    startBtn.disabled = false;

    mediaRecorder.onstop = () => {
      const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
      const audioURL = URL.createObjectURL(audioBlob);

      audioPreview.src = audioURL;
      audioPreview.classList.remove("d-none");

      // attach blob to file input (optional) so user can re-submit easily
      // create a File object and put into DataTransfer for the input element
      const file = new File([audioBlob], "recorded_audio.wav", { type: "audio/wav" });
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      audioInput.files = dataTransfer.files;
    };
  });

  // Submit handler - AJAX
  const form = document.getElementById("audioUploadForm");
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const btn = document.getElementById("generateAudioBtn");
    btn.disabled = true;
    const orig = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

    const fd = new FormData();
    const file = audioInput.files[0];
    if (file) {
      fd.append("file", file, file.name);
    } else {
      alert("Please upload or record audio first.");
      btn.disabled = false;
      btn.innerHTML = orig;
      return;
    }

    // add summary length selection if desired
    const summaryLen = document.getElementById("summaryLengthSelect").value;
    fd.append("summary_length", summaryLen);

    const csrftoken = getCookie("csrftoken");

    try {
      const resp = await fetch("{% url 'audio_upload' %}", {
        method: "POST",
        body: fd,
        headers: {
          "X-CSRFToken": csrftoken
        },
      });
      const data = await resp.json();
      if (!data.success) {
        alert(data.error || "Failed to process audio.");
        btn.disabled = false;
        btn.innerHTML = orig;
        return;
      }

      // show result section and fill values
      document.getElementById("audioResultSection").classList.remove("d-none");
      document.getElementById("transcriptBox").innerText = "Transcript: " + (data.transcript || "");
      document.getElementById("shortSummary").innerText = data.summary.short_summary || "";
      const bulletsEl = document.getElementById("bulletsList");
      bulletsEl.innerHTML = "";
      (data.summary.bullets || []).forEach(b => {
        const li = document.createElement("li");
        li.innerText = b;
        bulletsEl.appendChild(li);
      });
      document.getElementById("detailedExplanation").innerText = data.summary.detailed_explanation || "";
      const termsEl = document.getElementById("keyTermsList");
      termsEl.innerHTML = "";
      (data.summary.key_terms || []).forEach(t => {
        const li = document.createElement("li");
        li.innerText = t;
        termsEl.appendChild(li);
      });

      // Downloads (these endpoints read from session latest_notes)
      document.getElementById("downloadPdfBtn").classList.remove("disabled");
      document.getElementById("downloadDocxBtn").classList.remove("disabled");

    } catch (err) {
      console.error(err);
      alert("Server error while processing audio.");
    } finally {
      btn.disabled = false;
      btn.innerHTML = orig;
    }
  });
</script>

{% endblock %}
