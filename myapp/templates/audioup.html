{% extends "index.html" %}
{% load static %}
{% block main %}

<section class="upload-section container">
  <div class="upload-card mx-auto">

    <h3 class="text-center">Upload Audio to Generate Notes</h3>
    <p class="text-center text-muted">
      Upload your audio file or record your voice. Our AI assistant will convert
      speech into clean notes.
    </p>

    <form id="audioUploadForm" method="POST" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="drop-area text-center">
        <i class="fas fa-microphone-lines"></i>
        <h6>Drag & Drop your audio file here</h6>
        <p class="text-muted mb-1">or click below to select</p>

        <input
          type="file"
          class="form-control mt-2"
          accept="audio/*,.mp3,.wav,.m4a"
          id="audioInput"
          name="file"
        />
      </div>

      <br>

      <div class="my-3">
        <label class="form-label fw-semibold text-secondary">
          Or record your voice:
        </label>

        <div class="d-flex flex-wrap gap-2">
          <button type="button" id="startRecord" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-circle-dot me-2"></i> Start Recording
          </button>

          <button type="button" id="stopRecord" class="btn btn-outline-danger btn-sm" disabled>
            <i class="fas fa-square me-2"></i> Stop
          </button>
        </div>

        <audio id="audioPreview" controls class="mt-3 w-100 d-none"></audio>
      </div>

      <button type="submit" id="generateAudioBtn" class="generate-btn w-100">
        <i class="fas fa-wand-magic-sparkles me-2"></i> Generate Notes
      </button>
    </form>

    <!-- RESULT SECTION -->
    <div class="result-section d-none" id="audioResultSection">

      <h5 class="mt-4">
        <i class="fas fa-wand-magic-sparkles me-2"></i> Generated Notes:
      </h5>

      <div id="transcriptBox" class="mb-3"></div>

      <div id="summaryBox" class="mt-2 summary-box" style="text-align: justify;">
        <h6>‚≠ê Short Summary</h6>
        <p id="shortSummary"></p>

        <h6>‚≠ê Bullet Points</h6>
        <ul id="bulletsList"></ul>

        <h6>‚≠ê Detailed Explanation</h6>
        <p id="detailedExplanation"></p>

        <h6>‚≠ê Key Terms</h6>
        <p id="keyTermsList"></p>
      </div>

      

      <!-- Export -->
      <div class="d-flex gap-2 mt-3">
        <a id="downloadPdfBtn" href="{% url 'download_pdf' %}" class="btn btn-primary w-50" target="_blank">
          Export as PDF
        </a>
        <a id="downloadDocxBtn" href="{% url 'download_docx' %}" class="btn btn-outline-primary w-50" target="_blank">
          Export as Word
        </a>
      </div>

      <!-- Save -->
      <div class="mt-3">
        <input type="text" id="noteTitleInput" class="form-control mb-2" placeholder="Enter title (optional)">
        <button id="saveNotesBtn" class="btn btn-success w-100 disabled">
          üíæ Save Notes
        </button>
      </div>

      <!-- Evaluation -->
      <div id="evaluationBox" class="mt-3 p-3 rounded shadow-sm d-none">
        <h6>üìä Evaluation Metrics</h6>
        <p><strong>ROUGE-1:</strong> <span id="audioRouge1"></span>%</p>
        <p><strong>ROUGE-L:</strong> <span id="audioRougeL"></span>%</p>
        <p><strong>Compression Ratio:</strong> <span id="audioCompression"></span>%</p>
      </div>

    </div>
  </div>
</section>

<form id="saveNotesForm" action="{% url 'save_notes' %}" method="POST" style="display:none;">
  {% csrf_token %}
  <input type="hidden" name="notes_data" id="hiddenNotesData">
  <input type="hidden" name="title" id="hiddenTitle">
  <input type="hidden" name="note_type" value="audio">
</form>

<script>
function qs(id){ return document.getElementById(id); }

let mediaRecorder;
let audioChunks = [];

const startBtn = qs("startRecord");
const stopBtn = qs("stopRecord");
const audioPreview = qs("audioPreview");
const audioInput = qs("audioInput");
const form = qs("audioUploadForm");
const generateBtn = qs("generateAudioBtn");
const resultSection = qs("audioResultSection");
const saveBtn = qs("saveNotesBtn");

startBtn.addEventListener("click", async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];
  mediaRecorder.start();
  startBtn.disabled = true;
  stopBtn.disabled = false;
  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
});

stopBtn.addEventListener("click", () => {
  mediaRecorder.stop();
  stopBtn.disabled = true;
  startBtn.disabled = false;

  mediaRecorder.onstop = () => {
    const blob = new Blob(audioChunks, { type: "audio/wav" });
    audioPreview.src = URL.createObjectURL(blob);
    audioPreview.classList.remove("d-none");

    const file = new File([blob], "recorded_audio.wav");
    const dt = new DataTransfer();
    dt.items.add(file);
    audioInput.files = dt.files;
  };
});

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  generateBtn.disabled = true;
  generateBtn.innerHTML = "Processing... ‚è≥";

  const file = audioInput.files[0];
  if (!file) {
    alert("Please upload or record audio first.");
    generateBtn.disabled = false;
    generateBtn.innerHTML = "Generate Notes";
    return;
  }

  const fd = new FormData();
  fd.append("file", file);

  const resp = await fetch("{% url 'audio_upload' %}", {
    method: "POST",
    body: fd
  });

  const data = await resp.json();

  if (!data.success) {
    alert(data.error);
    generateBtn.disabled = false;
    generateBtn.innerHTML = "Generate Notes";
    return;
  }

  resultSection.classList.remove("d-none");

  // Transcript Expandable
  const transcriptText = data.transcript || "";
  const shortTranscript = transcriptText.split(" ").slice(0, 30).join(" ");

  qs("transcriptBox").innerHTML = `
    <div class="p-3 bg-dark text-light rounded shadow-sm" style="background:#e8f3ff;">
      <strong>Transcript:</strong>
      <p id="transcriptPreview">${shortTranscript}...</p>
      <a href="#" id="toggleTranscript" style="font-size:14px;">Read full transcript</a>
      <p id="fullTranscript" class="d-none mt-2">${transcriptText}</p>
    </div>
  `;

  document.getElementById("toggleTranscript").addEventListener("click", function(e){
    e.preventDefault();
    const full = document.getElementById("fullTranscript");
    const preview = document.getElementById("transcriptPreview");

    if(full.classList.contains("d-none")){
        full.classList.remove("d-none");
        preview.classList.add("d-none");
        this.innerText = "Show less";
    } else {
        full.classList.add("d-none");
        preview.classList.remove("d-none");
        this.innerText = "Read full transcript";
    }
  });

  qs("shortSummary").innerText = data.summary.short_summary;
  qs("detailedExplanation").innerText = data.summary.detailed_explanation;
  qs("keyTermsList").innerText = (data.summary.key_terms || []).join(", ");

  const bulletsEl = qs("bulletsList");
  bulletsEl.innerHTML = "";
  data.summary.bullets.forEach(b => {
    const li = document.createElement("li");
    li.innerText = b;
    bulletsEl.appendChild(li);
  });

  generateBtn.innerHTML = "Generate Notes";
  generateBtn.disabled = false;
  saveBtn.classList.remove("disabled");

  if (data.evaluation) {
    qs("evaluationBox").classList.remove("d-none");
    qs("audioRouge1").innerText = data.evaluation.rouge1;
    qs("audioRougeL").innerText = data.evaluation.rougeL;
    qs("audioCompression").innerText = data.evaluation.compression;
  }
});
</script>

{% endblock %}