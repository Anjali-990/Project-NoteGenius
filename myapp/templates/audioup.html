  {% extends "index.html" %}
  {% load static %}
  {% block main %}

  <section class="upload-section container">
    <div class="upload-card mx-auto">
      <h3 class="text-center">Upload Audio to Generate Notes</h3>
      <p class="text-center text-muted">
        Upload your audio file or record your voice. Our AI assistant will convert
        speech into clean notes.
      </p>

      <form id="audioUploadForm" enctype="multipart/form-data">
        {% csrf_token %}
        <!-- Drop Area -->
        <div class="drop-area text-center">
          <i class="fas fa-microphone-lines"></i>
          <h6>Drag & Drop your audio file here</h6>
          <p class="text-muted mb-1">or click below to select</p>

          <input
            type="file"
            class="form-control mt-2"
            accept="audio/*,.mp3,.wav,.m4a"
            id="audioInput"
            name="file"
          />
        </div>
        <br>

        <!-- Recording Section -->
        <div class="my-3">
          <label class="form-label fw-semibold text-secondary">
            Or record your voice:
          </label>

          <div class="d-flex flex-wrap gap-2">
            <button
              type="button"
              id="startRecord"
              class="btn btn-outline-primary btn-sm"
            >
              <i class="fas fa-circle-dot me-2"></i> Start Recording
            </button>

            <button
              type="button"
              id="stopRecord"
              class="btn btn-outline-danger btn-sm"
              disabled
            >
              <i class="fas fa-square me-2" style="color: #dc3545 !important; opacity: 1 !important;"></i>
              <span style="color: #dc3545 !important; font-weight: bold; opacity: 1 !important;">Stop</span>
            </button>
          </div>

          <audio id="audioPreview" controls class="mt-3 w-100 d-none"></audio>
        </div>
        

        <!-- hidden length selector (kept hidden per requirement) -->
        <div class="my-3 d-none" id="summaryLengthWrapper" >
          <select id="summaryLengthSelect" class="form-control" name="summary_length" style="max-width:260px;">
            <option value="medium" selected>Medium (Balanced)</option>
            <option value="short">Short (Quick)</option>
            <option value="long">Long (Detailed)</option>
          </select>
        </div>

        <button type="submit" id="generateAudioBtn" class="generate-btn w-100">
          <i class="fas fa-wand-magic-sparkles me-2"></i> Generate Notes
        </button>
      </form>
      <br>

      <!-- Result Section -->
      <div class="result-section d-none" id="audioResultSection">
        <h5 class="mt-4">
          <i class="fas fa-wand-magic-sparkles me-2"></i> Generated Notes:
        </h5>


        <div id="transcriptBox" class="mb-3"></div>
        

        <div id="summaryBox" class="mt-2" class="summary-box" style="text-align: justify;">
          <h6>‚≠ê Short Summary</h6>
          <p id="shortSummary"></p>

          <h6>‚≠ê Bullet Points</h6>
          <ul id="bulletsList"></ul>

          <h6>‚≠ê Detailed Explanation</h6>
          <p id="detailedExplanation"></p>

          <h6>‚≠ê Key Terms</h6>
          <ul id="keyTermsList"></ul>
        </div>

        <div class="d-flex gap-2 mt-3">
          <a id="downloadPdfBtn" href="{% url 'download_pdf' %}" class="btn btn-primary w-50 disabled" target="_blank">
            <i class="fas fa-file-pdf me-1"></i> Export as PDF
          </a>
          <a id="downloadDocxBtn" href="{% url 'download_docx' %}" class="btn btn-outline-primary w-50 disabled" target="_blank">
            <i class="fas fa-file-word me-1"></i> Export as Word
          </a>
        </div>

        <!-- SAVE: visible after generation; submits hidden form -->
        <div class="mt-3">
          <input type="text" id="noteTitleInput" class="form-control mb-2" placeholder="Enter title (optional)" style="max-width:520px;">
          <button id="saveNotesBtn" class="btn btn-success w-100 disabled">üíæ Save Notes</button>
        </div>

      </div>
    </div>
  </section>

  <!-- Hidden form used to POST to Django save_notes (regular form POST so your view handles it) -->
  <form id="saveNotesForm" action="{% url 'save_notes' %}" method="POST" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="notes_data" id="hiddenNotesData" value="">
    <input type="hidden" name="title" id="hiddenTitle" value="">
    <input type="hidden" name="note_type" id="hiddenType" value="audio">
  </form>

  <script>
    function qs(id){ return document.getElementById(id); }

    let mediaRecorder;
    let audioChunks = [];
    const startBtn = qs("startRecord");
    const stopBtn = qs("stopRecord");
    const audioPreview = qs("audioPreview");
    const audioInput = qs("audioInput");
    const form = qs("audioUploadForm");
    const generateBtn = qs("generateAudioBtn");
    const resultSection = qs("audioResultSection");
    const saveBtn = qs("saveNotesBtn");
    const saveForm = qs("saveNotesForm");
    const hiddenNotesData = qs("hiddenNotesData");
    const hiddenTitle = qs("hiddenTitle");
    const noteTitleInput = qs("noteTitleInput");

    startBtn.addEventListener("click", async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
        mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
      } catch (err) {
        alert("Microphone access denied or not available.");
      }
    });

    stopBtn.addEventListener("click", () => {
      if (!mediaRecorder) return;
      mediaRecorder.stop();
      stopBtn.disabled = true;
      startBtn.disabled = false;
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
        const audioURL = URL.createObjectURL(audioBlob);
        audioPreview.src = audioURL;
        audioPreview.classList.remove("d-none");
        const file = new File([audioBlob], "recorded_audio.wav", { type: "audio/wav" });
        const dt = new DataTransfer();
        dt.items.add(file);
        audioInput.files = dt.files;
      };
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      generateBtn.disabled = true;
      const orig = generateBtn.innerHTML;
      generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

      const fd = new FormData();
      const file = audioInput.files[0];
      if (!file) {
        alert("Please upload or record audio first.");
        generateBtn.disabled = false;
        generateBtn.innerHTML = orig;
        return;
      }
      fd.append("file", file, file.name);
      const summaryLen = qs("summaryLengthSelect")?.value || "medium";
      fd.append("summary_length", summaryLen);

      try {
        const resp = await fetch("{% url 'audio_upload' %}", {
          method: "POST",
          body: fd,
          credentials: "same-origin"
        });
        const data = await resp.json();
        if (!data || !data.success) {
          alert(data?.error || "Failed to process audio.");
          return;
        }

        resultSection.classList.remove("d-none");
        qs("transcriptBox").innerText = "Transcript: " + (data.transcript || "");
        qs("shortSummary").innerText = data.summary?.short_summary || "";
        const bulletsEl = qs("bulletsList"); bulletsEl.innerHTML = "";
        (data.summary?.bullets || []).forEach(b => { const li = document.createElement("li"); li.innerText = b; bulletsEl.appendChild(li); });
        qs("detailedExplanation").innerText = data.summary?.detailed_explanation || "";
        const termsEl = qs("keyTermsList"); termsEl.innerHTML = "";
        (data.summary?.key_terms || []).forEach(t => { const li = document.createElement("li"); li.innerText = t; termsEl.appendChild(li); });

        qs("downloadPdfBtn").classList.remove("disabled");
        qs("downloadDocxBtn").classList.remove("disabled");

        hiddenNotesData.value = JSON.stringify(data.summary || {});
        hiddenTitle.value = (noteTitleInput.value || (data.summary?.short_summary || "Audio Note")).slice(0, 200);

        saveBtn.classList.remove("disabled");
        saveBtn.innerText = "üíæ Save Notes";

      } catch (err) {
        console.error(err);
        alert("Server error while processing audio.");
      } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = orig;
      }
    });

    saveBtn.addEventListener("click", (e) => {
      if (saveBtn.classList.contains("disabled")) return;
      hiddenTitle.value = (noteTitleInput.value || hiddenTitle.value || "Untitled Note").slice(0, 200);
      saveForm.submit();
    });
  </script>

  {% endblock %}
