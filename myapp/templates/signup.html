{% extends "index.html" %}
{% load static %}
{% block main %}

<section class="upload-section">
  <div class="upload-card" style="max-width: 450px; margin: 0 auto;">
    <h3 class="mb-3">Create your NoteGenius account</h3>
    <p class="text-muted mb-4">
      Sign up to start generating smart notes, QnA, and quizzes.
    </p>

    {% if error %}
    <div class="alert alert-danger">
      {{ error }}
    </div>
    {% endif %}

    <form method="post" id="signupForm">
      {% csrf_token %}

      <div class="mb-3 text-start">
        <label class="form-label fw-semibold text-secondary" for="username">
          Username
        </label>
        <input
          type="text"
          class="form-control"
          id="username"
          name="username"
          placeholder="Choose a username"
          required
        />
      </div>

      <div class="mb-3 text-start">
        <label class="form-label fw-semibold text-secondary" for="email">
          Email
        </label>
        <input
          type="email"
          class="form-control"
          id="email"
          name="email"
          placeholder="Enter your email"
          required
        />
      </div>

      <div class="mb-3 text-start">
        <label class="form-label fw-semibold text-secondary" for="phone">
          Mobile number (optional)
        </label>
        <input
          type="tel"
          class="form-control"
          id="phone"
          name="phone"
          placeholder="Enter your mobile number"
        />
      </div>

      <!-- OTP section -->
      <div class="mb-3 text-start">
        <label class="form-label fw-semibold text-secondary">
          Verify with OTP
        </label>
        <div class="d-flex gap-2 mb-2">
          <button
            type="button"
            id="signupSendOtp"
            class="btn btn-sm btn-outline-primary"
          >
            Send OTP
          </button>
          <span
            id="signupOtpStatus"
            class="small text-muted align-self-center"
          >
            OTP will be sent to your email .
          </span>
        </div>

        <input
          type="text"
          class="form-control"
          id="signupOtpInput"
          name="signup_otp"
          placeholder="Enter OTP"
          maxlength="6"
          disabled
        />
      </div>

      <div class="mb-3 text-start">
        <label class="form-label fw-semibold text-secondary" for="password1">
          Password
        </label>
        <input
          type="password"
          class="form-control"
          id="password1"
          name="password1"
          placeholder="Create a password"
          required
        />
      </div>

      <div class="mb-3 text-start">
        <label class="form-label fw-semibold text-secondary" for="password2">
          Confirm Password
        </label>
        <input
          type="password"
          class="form-control"
          id="password2"
          name="password2"
          placeholder="Re-enter your password"
          required
        />
      </div>

      <button type="submit" class="generate-btn w-100">
        <i class="fas fa-user-plus me-2"></i>
        Sign up
      </button>
    </form>

    <p class="mt-3 text-center">
      Already have an account?
      <a href="{% url 'login' %}">Login</a>
    </p>
  </div>
</section>

<script>
  // helper to get CSRF cookie
  function getCsrfToken() {
    const name = "csrftoken";
    const cookies = document.cookie.split(";");
    for (let c of cookies) {
      c = c.trim();
      if (c.startsWith(name + "=")) return decodeURIComponent(c.substring(name.length + 1));
    }
    return "";
  }

  const signupSendOtpBtn = document.getElementById("signupSendOtp");
  const signupOtpInput = document.getElementById("signupOtpInput");
  const signupOtpStatus = document.getElementById("signupOtpStatus");
  const emailInput = document.getElementById("email");

  if (signupSendOtpBtn) {
    signupSendOtpBtn.addEventListener("click", function () {
      const loginId = (emailInput.value || "").trim();
      if (!loginId) {
        signupOtpStatus.textContent = "Please enter your email first.";
        signupOtpStatus.classList.remove("text-muted", "text-success");
        signupOtpStatus.classList.add("text-danger");
        return;
      }

      signupOtpStatus.textContent = "Sending OTP...";
      signupOtpStatus.classList.remove("text-danger", "text-success");
      signupOtpStatus.classList.add("text-muted");

      fetch("{% url 'send_login_otp' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCsrfToken()
        },
        body: new URLSearchParams({ login_id: loginId })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          signupOtpInput.disabled = false;
          signupOtpInput.focus();
          signupOtpStatus.textContent = data.message || "OTP sent.";
          signupOtpStatus.classList.remove("text-muted", "text-danger");
          signupOtpStatus.classList.add("text-success");
        } else {
          signupOtpStatus.textContent = data.message || "Failed to send OTP.";
          signupOtpStatus.classList.remove("text-muted", "text-success");
          signupOtpStatus.classList.add("text-danger");
        }
      })
      .catch(() => {
        signupOtpStatus.textContent = "Network error sending OTP.";
        signupOtpStatus.classList.remove("text-muted", "text-success");
        signupOtpStatus.classList.add("text-danger");
      });
    });
  }
</script>


{% endblock %}
