{% extends "index.html" %}
{% load static %}
{% block main %}

<section class="upload-section">
  <div class="upload-card" style="max-width: 450px; margin: 0 auto;">
    <h3 class="mb-3">Login to NoteGenius</h3>
    <p class="text-muted mb-4">
      Use your email / mobile and password, or login with OTP.
    </p>

    {# --- Django messages (signup success, other notices) --- #}
    {% if messages %}
      {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert" style="border-radius:10px;">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    {% if error %}
    <div class="alert alert-danger">
      {{ error }}
    </div>
    {% endif %}

    <form method="post" id="loginForm">
      {% csrf_token %}

      <div class="mb-3 text-start">
        <label class="form-label fw-semibold text-secondary" for="loginId">
          Email or Mobile
        </label>
        <input
          type="text"
          class="form-control"
          id="loginId"
          name="login_id"
          placeholder="Enter your email or mobile"
          required
        />
      </div>

      <!-- Password login -->
      <div class="mb-3 text-start">
        <label class="form-label fw-semibold text-secondary" for="password">
          Password
        </label>
        <input
          type="password"
          class="form-control"
          id="password"
          name="password"
          placeholder="Enter your password"
        />
      </div>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            id="remember"
            name="remember"
          />
          <label class="form-check-label" for="remember">
            Remember me
          </label>
        </div>
        <a href="#" class="small text-decoration-none">Forgot password?</a>
      </div>

      <button type="submit" class="generate-btn w-100 mb-3">
        <i class="fas fa-right-to-bracket me-2"></i>
        Login with password
      </button>

      <hr class="my-3" />

      <!-- OTP login section (frontend) -->
      <div class="mb-2 text-start">
        <label class="form-label fw-semibold text-secondary">
          Or login with OTP
        </label>
        <div class="d-flex gap-2 mb-2">
          <button
            type="button"
            id="loginSendOtp"
            class="btn btn-sm btn-outline-primary"
          >
            Send OTP
          </button>
          <span
            id="loginOtpStatus"
            class="small text-muted align-self-center"
          >
            OTP will be sent to your email / mobile.
          </span>
        </div>

        <input
          type="text"
          class="form-control"
          id="loginOtpInput"
          name="login_otp"
          placeholder="Enter OTP"
          maxlength="6"
          disabled
        />
      </div>

      <button type="submit" class="btn btn-outline-secondary w-100 mt-2">
        Login with OTP
      </button>

    </form>

    <p class="mt-3 text-center">
      Don't have an account?
      <a href="{% url 'signup' %}">Sign up</a>
    </p>
  </div>
</section>

<script>
  const loginSendOtpBtn = document.getElementById("loginSendOtp");
  const loginOtpInput = document.getElementById("loginOtpInput");
  const loginOtpStatus = document.getElementById("loginOtpStatus");
  const loginIdInput = document.getElementById("loginId");
  const loginForm = document.getElementById("loginForm");

  function getCsrfToken() {
    const name = "csrftoken";
    const cookies = document.cookie.split(";");
    for (let c of cookies) {
      c = c.trim();
      if (c.startsWith(name + "=")) {
        return c.substring(name.length + 1);
      }
    }
    return "";
  }

  // Prefill login field if ?email=... is present (useful after signup redirect)
  (function prefillFromQuery() {
    try {
      const params = new URLSearchParams(window.location.search);
      const pre = params.get("email") || params.get("login_id") || params.get("username");
      if (pre) {
        loginIdInput.value = pre;
        loginIdInput.focus();
      } else {
        // if there are messages (signup success), focus loginId for quick action
        const hasAlert = document.querySelector(".alert");
        if (hasAlert) loginIdInput.focus();
      }
    } catch (e) {
      // ignore
    }
  })();

  if (loginSendOtpBtn) {
    loginSendOtpBtn.addEventListener("click", function () {
      const loginId = loginIdInput.value.trim();
      if (!loginId) {
        loginOtpStatus.textContent = "Please enter your email first.";
        loginOtpStatus.classList.remove("text-muted", "text-success");
        loginOtpStatus.classList.add("text-danger");
        return;
      }

      fetch("{% url 'send_login_otp' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCsrfToken(),
        },
        body: new URLSearchParams({ login_id: loginId }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.success) {
            loginOtpInput.disabled = false;
            loginOtpInput.focus();
            loginOtpStatus.textContent = data.message;
            loginOtpStatus.classList.remove("text-muted", "text-danger");
            loginOtpStatus.classList.add("text-success");
          } else {
            loginOtpStatus.textContent = data.message;
            loginOtpStatus.classList.remove("text-muted", "text-success");
            loginOtpStatus.classList.add("text-danger");
          }
        })
        .catch(() => {
          loginOtpStatus.textContent = "Error sending OTP. Try again.";
          loginOtpStatus.classList.remove("text-muted", "text-success");
          loginOtpStatus.classList.add("text-danger");
        });
    });
  }
</script>

{% endblock %}
