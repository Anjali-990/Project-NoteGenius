{% extends "index.html" %}
{% load static %}
{% block main %}

<section class="upload-section container">
  <div class="upload-card mx-auto">
    <h3 class="text-center">Upload Video to Generate Notes</h3>
    <p class="text-center text-muted">
      Upload your video or record a clip. Our AI will extract audio, convert it to text, and generate summarized notes.
    </p>

    <form id="videoUploadForm" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="drop-area text-center">
        <i class="fas fa-video"></i>
        <h6>Drag & Drop your video file here</h6>
        <p class="text-muted mb-1">or click below to select</p>

        <input
          type="file"
          name="file"
          class="form-control mt-2"
          accept="video/*,.mp4,.mkv,.mov"
          id="videoInput"
        />
      </div>
      <br>

      <button type="submit" class="generate-btn w-100">
        <i class="fas fa-wand-magic-sparkles me-2"></i> Generate Notes
      </button>
    </form>

    <!-- RESULT SECTION -->
    <div id="videoResultSection" class="d-none mt-4">

      <!-- Processing -->
      <div id="videoProcessing" class="text-center d-none">
        <div class="spinner-border text-primary"></div>
        <p class="mt-2">Processing your video... Please wait.</p>
      </div>

      <!-- Output -->
      <div id="videoOutput" class="d-none">

        <h5 class="mt-4">
          <i class="fas fa-wand-magic-sparkles me-2"></i> Generated Notes:
        </h5>

        <div id="videoSummaryText"
             class="summary-box mt-2 position-relative"
             style="text-align: justify;">
        </div>

        <div class="mt-3">
          <a href="{% url 'download_pdf' %}" class="btn btn-sm btn-danger">Download PDF</a>
          <a href="{% url 'download_docx' %}" class="btn btn-sm btn-primary">Download DOCX</a>
        </div>

      </div>
    </div>

    <div class="alert alert-danger mt-3 d-none" id="videoError"></div>

  </div>
</section>

<script>
const form = document.getElementById("videoUploadForm");
const resultSection = document.getElementById("videoResultSection");
const processingDiv = document.getElementById("videoProcessing");
const outputDiv = document.getElementById("videoOutput");
const summaryText = document.getElementById("videoSummaryText");
const errorBox = document.getElementById("videoError");

form.addEventListener("submit", async function(e) {
  e.preventDefault();

  const fileInput = document.getElementById("videoInput");

  if (!fileInput.files.length) {
    alert("Please select a video file.");
    return;
  }

  const submitBtn = form.querySelector("button[type='submit']");
  submitBtn.disabled = true;
  submitBtn.innerHTML =
    '<span class="spinner-border spinner-border-sm me-2"></span> Processing...';

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);

  // üî• Important Fix ‚Äî no white box
  processingDiv.classList.remove("d-none");
  outputDiv.classList.add("d-none");
  errorBox.classList.add("d-none");

  try {
    const response = await fetch("{% url 'video_upload' %}", {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
      }
    });

    const data = await response.json();

    processingDiv.classList.add("d-none");
    resultSection.classList.remove("d-none");

    if (data.success) {
      outputDiv.classList.remove("d-none");

      summaryText.innerHTML = `
        <h6>‚≠ê Short Summary</h6>
        <p>${data.summary.short_summary}</p>

        <h6>‚≠ê Bullet Points</h6>
        <ul>
          ${data.summary.bullets.map(b => `<li>${b}</li>`).join("")}
        </ul>

        <h6>‚≠ê Detailed Explanation</h6>
        <p>${data.summary.detailed_explanation}</p>
      `;

      // Copy Button
      if (!summaryText.querySelector(".copy-btn")) {
        const btn = document.createElement("button");
        btn.innerHTML = '<i class="fas fa-copy"></i>';
        btn.className = "btn btn-sm btn-outline-light copy-btn";
        btn.style.position = "absolute";
        btn.style.top = "5px";
        btn.style.right = "5px";

        btn.addEventListener("click", function () {
          navigator.clipboard.writeText(summaryText.innerText);
          btn.innerHTML = "‚úî";
          setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-copy"></i>';
          }, 1500);
        });

        summaryText.prepend(btn);
      }

    } else {
      errorBox.innerText = data.error;
      errorBox.classList.remove("d-none");
    }

  } catch (err) {
    processingDiv.classList.add("d-none");
    errorBox.innerText = "Server error while processing video.";
    errorBox.classList.remove("d-none");
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML =
      '<i class="fas fa-wand-magic-sparkles me-2"></i> Generate Notes';
  }
});
</script>

{% endblock %}